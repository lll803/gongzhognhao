# TopHub 热榜采集系统

本系统集成了 TopHub API，用于自动采集微信等平台的热门内容榜单数据。

## 功能特性

- 🔄 自动刷新 6 个微信热门榜单
- 💾 数据持久化到 Supabase 数据库
- 🚫 智能去重，避免重复数据
- 📊 实时状态监控和统计
- 🎯 支持单个榜单刷新和批量刷新

## 目标榜单

| 榜单名称 | HashID | 描述 |
|---------|---------|------|
| 微信24小时热文榜 | `WnBe01o371` | 微信平台24小时热门文章 |
| 微信生活24小时热文榜 | `nBe0xxje37` | 生活类热门内容 |
| 微信文化24小时热文榜 | `proPGGOeq6` | 文化类热门内容 |
| 微信健康24小时热文榜 | `Q0orrr0o8B` | 健康类热门内容 |
| 微信美食24小时热文榜 | `m4ejxxyvxE` | 美食类热门内容 |
| 微信情感24小时热文榜 | `1VdJ77keLQ` | 情感类热门内容 |

## 环境配置

### 必需环境变量

```bash
# Supabase 配置
SUPABASE_URL=your_supabase_project_url
SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key

# TopHub API 配置
TOPHUB_API_KEY=your_tophub_api_key
TOPHUB_BASE_URL=https://api.tophubdata.com
```

### 获取 TopHub API Key

1. 访问 [TopHub 官网](https://www.tophubdata.com/)
2. 注册账号并登录
3. 在个人中心获取 API Key
4. 将 API Key 设置为环境变量 `TOPHUB_API_KEY`

## 数据库设置

### 1. 创建 Supabase 项目

1. 访问 [Supabase](https://supabase.com/)
2. 创建新项目
3. 获取项目 URL 和 Service Role Key

### 2. 执行数据库迁移

在 Supabase SQL Editor 中执行以下 SQL：

```sql
-- 创建榜单元数据表
create table if not exists public.hotboards (
  id bigint generated by default as identity primary key,
  hashid text not null unique,
  name text not null,
  display text not null,
  domain text not null,
  logo text,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

-- 创建热榜项目表
create table if not exists public.hotitems (
  id bigint generated by default as identity primary key,
  hashid text not null,
  rank int not null,
  title text not null,
  description text,
  url text not null,
  thumbnail text,
  extra text,
  hot_value int not null default 0,
  collected_at timestamptz not null default now(),
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),
  constraint hotitems_hashid_url_unique unique (hashid, url),
  constraint hotitems_hashid_fk foreign key (hashid) references public.hotboards(hashid) on delete cascade
);

-- 创建索引
create index if not exists hotitems_hashid_rank_idx on public.hotitems (hashid, rank);
create index if not exists hotitems_collected_at_idx on public.hotitems (collected_at desc);
```

## API 接口

### 1. 刷新热榜数据

```http
POST /api/scraping/tophub/refresh
```

**查询参数：**
- `hashid` (可选): 指定刷新单个榜单，不传则刷新所有榜单

**响应示例：**
```json
{
  "success": true,
  "total": 120,
  "results": [
    {
      "hashid": "WnBe01o371",
      "ok": true,
      "count": 20
    }
  ]
}
```

### 2. 获取热榜项目

```http
GET /api/scraping/tophub/items?limit=50&hashids=WnBe01o371,nBe0xxje37
```

**查询参数：**
- `limit` (可选): 返回项目数量，默认50，最大200
- `hashids` (可选): 指定榜单hashid，多个用逗号分隔

**响应示例：**
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 1,
        "hashid": "WnBe01o371",
        "rank": 1,
        "title": "文章标题",
        "description": "文章描述",
        "url": "https://example.com",
        "hot_value": 1000000,
        "collected_at": "2024-01-15T10:00:00Z"
      }
    ]
  }
}
```

### 3. 获取统计信息

```http
GET /api/scraping/tophub/stats
```

**响应示例：**
```json
{
  "success": true,
  "data": {
    "totalBoards": 6,
    "totalItems": 120,
    "itemsByBoard": {
      "WnBe01o371": 20,
      "nBe0xxje37": 20
    },
    "latestUpdate": "2024-01-15T10:00:00Z",
    "boardDetails": [
      {
        "hashid": "WnBe01o371",
        "name": "知乎",
        "itemCount": 20,
        "lastUpdated": "2024-01-15T10:00:00Z"
      }
    ]
  }
}
```

## 使用方法

### 1. 启动系统

```bash
# 安装依赖
npm install

# 设置环境变量
cp env.example .env.local
# 编辑 .env.local 文件，填入实际的配置值

# 启动开发服务器
npm run dev
```

### 2. 访问采集页面

打开浏览器访问：`http://localhost:3000/scraping`

### 3. 刷新数据

点击"刷新全部"按钮，系统将：
1. 依次刷新每个榜单（避免后端超时）
2. 显示每个榜单的刷新状态
3. 自动去重并保存到数据库
4. 更新页面显示最新数据

## 数据流程

```
TopHub API → 数据解析 → 去重检查 → Supabase 存储 → 前端展示
     ↓              ↓         ↓         ↓         ↓
  获取热榜 → 提取标题/链接 → 检查重复 → 保存数据 → 用户查看
```

## 注意事项

1. **API 限制**: TopHub API 可能有调用频率限制，建议不要过于频繁刷新
2. **数据去重**: 系统基于 `(hashid, url)` 进行去重，确保不会保存重复内容
3. **错误处理**: 如果某个榜单刷新失败，不会影响其他榜单的刷新
4. **超时控制**: 刷新过程中增加了延迟，避免后端服务超时

## 故障排除

### 常见问题

1. **环境变量未设置**
   - 检查 `.env.local` 文件是否存在
   - 确认所有必需的环境变量都已设置

2. **Supabase 连接失败**
   - 检查 `SUPABASE_URL` 和 `SUPABASE_SERVICE_ROLE_KEY` 是否正确
   - 确认 Supabase 项目状态正常

3. **TopHub API 调用失败**
   - 检查 `TOPHUB_API_KEY` 是否有效
   - 确认 API Key 有足够的权限

4. **数据库表不存在**
   - 在 Supabase SQL Editor 中执行数据库迁移脚本
   - 检查表名和字段名是否正确

### 日志查看

系统会在控制台输出详细的错误信息，包括：
- API 调用状态
- 数据库操作结果
- 错误详情和堆栈信息

## 扩展功能

### 添加新榜单

1. 在 `components/hot-items.tsx` 中的 `TARGET_BOARDS` 数组添加新条目
2. 确保 TopHub 平台上有对应的榜单
3. 重启应用即可生效

### 自定义刷新间隔

可以在 `app/api/scraping/tophub/refresh/route.ts` 中调整刷新延迟时间：

```typescript
// 当前设置为 500ms，可以根据需要调整
await new Promise(resolve => setTimeout(resolve, 500))
```

### 数据导出

可以基于现有的 API 接口开发数据导出功能，支持 CSV、JSON 等格式。

## 技术支持

如果遇到问题，请检查：
1. 环境变量配置
2. 网络连接状态
3. API 密钥有效性
4. 数据库连接状态

更多信息请参考项目文档或联系技术支持。
